import { execSync } from 'child_process';
import { writeFileSync } from 'fs';
import path from 'path';

function safeExec(cmd) {
    try {
        return execSync(cmd, { stdio: ['ignore', 'pipe', 'ignore'] }).toString().trim();
    } catch (e) {
        return '';
    }
}

const commit = safeExec('git rev-parse --short HEAD');
const tag = safeExec('git describe --tags --exact-match');

const outPath = path.join(process.cwd(), 'src', 'commitInfo.ts');
const content = `// This file is autogenerated at build time. Do not edit.
export const COMMIT = ${JSON.stringify(commit)};
export const TAG = ${JSON.stringify(tag)};
`;

try {
    writeFileSync(outPath, content, 'utf8');
    console.log('Wrote commit info to', outPath);
} catch (err) {
    console.error('Failed to write commit info:', err);
    process.exit(1);
}
